# START HERE: Supabase Auth Refactor

## What You Need To Know

**You are implementing v0.15.0 features with the correct Supabase auth pattern (non-blocking).**

The previous v0.15.0 implementation (commit `80c764f`) caused a **critical deadlock bug** where page refreshes hung indefinitely. The root cause: making AuthProvider callbacks `async` and awaiting database queries inside them. This violates official Supabase guidance and creates circular dependencies.

## Your Mission

Re-implement v0.15.0 features following the **non-blocking pattern** documented in official Supabase docs.

## Critical Documents (Read in Order)

1. **`.SUPABASE-AUTH-REFACTOR-PLAN.md`** - Complete implementation plan with exact code patterns
2. **`CLAUDE.md`** - Project docs (updated with anti-patterns section)
3. **`Supabase Auth Hanging Promises. Best Practices.md`** - External consultant analysis
4. **`.supabase-issue-summary.md`** - Our debugging session notes

## Current State

- **Branch**: `main` at commit `a31ecb6` (v0.14.0 - working version)
- **Investigation branch**: `investigate/supabase-hanging-promises` preserved with debug code
- **Broken commit**: `80c764f` (v0.15.0 - NEVER merge this)

## Implementation Sequence (MUST FOLLOW EXACTLY)

See **Phase 1-5** in `.SUPABASE-AUTH-REFACTOR-PLAN.md`. The order matters:

1. ✅ DONE - Update CLAUDE.md with anti-patterns
2. ✅ DONE - Extract v0.15.0 improvements to TODO backlog
3. ✅ DONE - Update Current Status to v0.14.0
4. Start here → Verify git state, revert if needed
5. Implement non-blocking AuthProvider (TWO separate useEffects)
6. Update components, delete old hook
7. Move Navigation to root layout
8. Add URL redirect with security validation
9. Add USER_UPDATED event handler
10. Update tests, run full suite
11. Manual testing with network throttling
12. Version bump to 0.15.0
13. Commit with detailed message

## The Core Pattern (Non-Negotiable)

```typescript
// ✅ Auth initialization (FAST PATH)
useEffect(() => {
  supabase.auth.getSession()
    .then(({ session }) => setUser(session?.user))
    .finally(() => setLoading(false))  // ALWAYS runs

  // Listener with ONLY synchronous operations
  const { data: { subscription } } = supabase.auth.onAuthStateChange(
    (event, session) => {
      setUser(session?.user || null)  // NO ASYNC, NO AWAIT
    }
  )
  return () => subscription.unsubscribe()
}, [])

// ✅ Admin check (SEPARATE, NON-BLOCKING)
useEffect(() => {
  if (!user) return

  const fetchAdmin = async () => {
    setAdminLoading(true)
    try {
      const status = await isUserAdmin(user.id)
      setIsAdmin(status)
    } finally {
      setAdminLoading(false)
    }
  }

  fetchAdmin()
}, [user?.id])
```

## Success Criteria

When complete:
- Page refresh (Cmd+R) loads data immediately (no hanging)
- Auth completes before admin check
- Failed admin queries don't block UI
- Navigation doesn't re-mount on route changes
- Login redirects to original destination (if safe)
- External redirects blocked
- All tests pass (145+)

## If Anything Hangs

1. Check console for "[AuthProvider]" logs
2. Verify NO async operations in auth callbacks
3. Verify admin check is in separate useEffect
4. Test with network throttling (DevTools → Slow 3G)
5. Check `.SUPABASE-AUTH-REFACTOR-PLAN.md` Phase 3.1 for exact code

## Quick Reference

**Files you'll modify**:
- `src/components/auth/auth-provider.tsx` - Core changes
- `src/components/layout/navigation.tsx` - Use useAuth() instead of useAdminCheck
- `src/components/items/item-detail-drawer.tsx` - Same
- `src/components/tasks/task-edit-dialog.tsx` - Same
- `src/components/notes/note-card.tsx` - Same
- `src/app/layout.tsx` - Add Navigation here
- `src/app/props/page.tsx` - Remove Navigation
- `src/app/tasks/page.tsx` - Remove Navigation
- `src/app/notes/page.tsx` - Remove Navigation
- `src/app/admin/invitations/page.tsx` - Remove Navigation
- `src/lib/redirect-utils.ts` - NEW - Security validation
- `src/components/auth/protected-route.tsx` - Save redirect URL
- `src/app/login/page.tsx` - Handle redirect after login

**Files you'll create**:
- `src/lib/redirect-utils.ts`
- `src/components/auth/__tests__/auth-provider-deadlock-prevention.test.tsx`

**Files you'll delete**:
- `src/hooks/use-admin-check.tsx` (obsolete)

## After Implementation

1. Run `npm test -- --coverage` - should pass 145+ tests
2. Manual test checklist in plan Phase 4.4
3. Commit with message from plan Phase 5.2
4. Run `npm run cleandev` to verify

## Questions?

All answers are in `.SUPABASE-AUTH-REFACTOR-PLAN.md`. The plan is complete and leaves no room for interpretation. Follow it exactly.

---

**Remember**: Auth initialization must be FAST. Supplementary queries (roles, profiles) load separately. Never block auth callbacks with async operations. This is the official Supabase pattern and prevents deadlocks.
